Index: settings
===================================================================
--- settings
+++ settings
@@ -1,17 +1,23 @@
 {
   "viaIR": false,
   "codegen": "yul",
   "remappings": [
-    "solidity-utils/=lib/solidity-utils/src/",
+    "aave-address-book/=lib/aave-helpers/lib/aave-address-book/src/",
+    "aave-helpers/=lib/aave-helpers/",
+    "aave-v3-origin-tests/=lib/aave-v3-origin/tests/",
+    "aave-v3-origin/=lib/aave-v3-origin/src/",
+    "erc4626-tests/=lib/aave-helpers/lib/solidity-utils/lib/openzeppelin-contracts-upgradeable/lib/erc4626-tests/",
     "forge-std/=lib/forge-std/src/",
-    "ds-test/=lib/forge-std/lib/ds-test/src/",
-    "openzeppelin-contracts-upgradeable/=lib/solidity-utils/lib/openzeppelin-contracts-upgradeable/",
-    "openzeppelin-contracts/=lib/solidity-utils/lib/openzeppelin-contracts-upgradeable/lib/openzeppelin-contracts/",
-    "@openzeppelin/contracts-upgradeable/=lib/solidity-utils/lib/openzeppelin-contracts-upgradeable/contracts/",
-    "@openzeppelin/contracts/=lib/solidity-utils/lib/openzeppelin-contracts-upgradeable/lib/openzeppelin-contracts/contracts/",
-    "erc4626-tests/=lib/solidity-utils/lib/openzeppelin-contracts-upgradeable/lib/erc4626-tests/",
-    "halmos-cheatcodes/=lib/solidity-utils/lib/openzeppelin-contracts-upgradeable/lib/halmos-cheatcodes/src/"
+    "openzeppelin-contracts-upgradeable/=lib/aave-helpers/lib/aave-address-book/lib/aave-v3-origin/lib/solidity-utils/lib/openzeppelin-contracts-upgradeable/",
+    "openzeppelin-contracts/=lib/aave-helpers/lib/aave-address-book/lib/aave-v3-origin/lib/solidity-utils/lib/openzeppelin-contracts-upgradeable/lib/openzeppelin-contracts/",
+    "solidity-utils/=lib/aave-helpers/lib/aave-address-book/lib/aave-v3-origin/lib/solidity-utils/src/",
+    "lib/aave-helpers/:aave-address-book/=lib/aave-helpers/lib/aave-address-book/src/",
+    "lib/aave-helpers/:solidity-utils/=lib/aave-helpers/lib/aave-address-book/lib/aave-v3-origin/lib/solidity-utils/src/",
+    "@openzeppelin/contracts-upgradeable/=lib/aave-v3-origin/lib/solidity-utils/lib/openzeppelin-contracts-upgradeable/contracts/",
+    "@openzeppelin/contracts/=lib/aave-v3-origin/lib/solidity-utils/lib/openzeppelin-contracts-upgradeable/lib/openzeppelin-contracts/contracts/",
+    "ds-test/=lib/aave-v3-origin/lib/forge-std/lib/ds-test/src/",
+    "halmos-cheatcodes/=lib/aave-v3-origin/lib/solidity-utils/lib/openzeppelin-contracts-upgradeable/lib/halmos-cheatcodes/src/"
   ],
   "evmVersion": "cancun",
   "outputSelection": {
     "*": {
@@ -28,8 +34,27 @@
   },
   "metadata": {
     "hashType": "none"
   },
-  "libraries": {},
+  "libraries": {
+    "lib/aave-v3-origin/src/contracts/protocol/libraries/logic/BorrowLogic.sol": {
+      "BorrowLogic": "0xF3b473A5c7f9be0aFD4eddD724b0519cee9314f8"
+    },
+    "lib/aave-v3-origin/src/contracts/protocol/libraries/logic/ConfiguratorLogic.sol": {
+      "ConfiguratorLogic": "0xAB7b29A2Bda1e9A4F228aAb53d41c4D63Fc22f5E"
+    },
+    "lib/aave-v3-origin/src/contracts/protocol/libraries/logic/FlashLoanLogic.sol": {
+      "FlashLoanLogic": "0xcBc69Dc132f02869Bed58e76A3Ff575855371ECF"
+    },
+    "lib/aave-v3-origin/src/contracts/protocol/libraries/logic/LiquidationLogic.sol": {
+      "LiquidationLogic": "0x4122978eb58D0Ccd857B06FF6881222eF41364A1"
+    },
+    "lib/aave-v3-origin/src/contracts/protocol/libraries/logic/PoolLogic.sol": {
+      "PoolLogic": "0xc06404b2aa898dbe96d0d7cf65b1de3194268743"
+    },
+    "lib/aave-v3-origin/src/contracts/protocol/libraries/logic/SupplyLogic.sol": {
+      "SupplyLogic": "0x2b139d7c4fb05db52a3261256797abc567a7cf36"
+    }
+  },
   "enableEraVMExtensions": false,
   "forceEVMLA": false
 }
\ No newline at end of file
===================================================================
--- src/contracts/instances/ATokenInstance.sol
+++ lib/aave-v3-origin/src/contracts/instances/ATokenInstance.sol
@@ -15,9 +15,9 @@
  * @author BGD Labs
  * @notice Instance of the interest bearing token for the Aave protocol
  */
 contract ATokenInstance is AToken {
-    uint256 public constant ATOKEN_REVISION = 4;
+    uint256 public constant ATOKEN_REVISION = 5;
 
     constructor(
         IPool pool,
         address rewardsController,
===================================================================
--- src/contracts/interfaces/IPool.sol
+++ lib/aave-v3-origin/src/contracts/interfaces/IPool.sol
@@ -588,17 +588,15 @@
      * @param from The user from which the aTokens are transferred
      * @param to The user receiving the aTokens
      * @param scaledAmount The scaled amount being transferred/withdrawn
      * @param scaledBalanceFromBefore The aToken scaled balance of the `from` user before the transfer
-     * @param scaledBalanceToBefore The aToken scaled balance of the `to` user before the transfer
      */
     function finalizeTransfer(
         address asset,
         address from,
         address to,
         uint256 scaledAmount,
-        uint256 scaledBalanceFromBefore,
-        uint256 scaledBalanceToBefore
+        uint256 scaledBalanceFromBefore
     ) external;
 
     /**
      * @notice Returns the list of the underlying assets of all the initialized reserves
@@ -676,8 +674,18 @@
         uint128 borrowableBitmap
     ) external;
 
     /**
+     * @notice Replaces the current eMode ltvzeroBitmap.
+     * @param id The id of the category
+     * @param ltvzeroBitmap The ltvzeroBitmap of the category
+     */
+    function configureEModeCategoryLtvzeroBitmap(
+        uint8 id,
+        uint128 ltvzeroBitmap
+    ) external;
+
+    /**
      * @notice Returns the data of an eMode category
      * @dev DEPRECATED use independent getters instead
      * @param id The id of the category
      * @return The configuration data of the category
@@ -687,8 +695,10 @@
     ) external view returns (DataTypes.EModeCategoryLegacy memory);
 
     /**
      * @notice Returns the label of an eMode category
+     * @dev This function is deprecated and will be removed in a future version.
+     * @custom:deprecated
      * @param id The id of the category
      * @return The label of the category
      */
     function getEModeCategoryLabel(
@@ -722,8 +732,17 @@
         uint8 id
     ) external view returns (uint128);
 
     /**
+     * @notice Returns the ltvzero of an eMode category
+     * @param id The id of the category
+     * @return The ltvzeroBitmap of the category
+     */
+    function getEModeCategoryLtvzeroBitmap(
+        uint8 id
+    ) external view returns (uint128);
+
+    /**
      * @notice Allows a user to use the protocol in eMode
      * @param categoryId The id of the category
      */
     function setUserEMode(uint8 categoryId) external;
@@ -910,13 +929,8 @@
      */
     function getBorrowLogic() external view returns (address);
 
     /**
-     * @notice Gets the address of the external EModeLogic
-     */
-    function getEModeLogic() external view returns (address);
-
-    /**
      * @notice Gets the address of the external LiquidationLogic
      */
     function getLiquidationLogic() external view returns (address);
 
===================================================================
--- src/contracts/protocol/libraries/helpers/Errors.sol
+++ lib/aave-v3-origin/src/contracts/protocol/libraries/helpers/Errors.sol
@@ -87,12 +87,16 @@
     error CallerNotRiskOrPoolOrEmergencyAdmin(); // 'The caller of the function is not a risk, pool or emergency admin'
     error LiquidationGraceSentinelCheckFailed(); // 'Liquidation grace sentinel validation failed'
     error InvalidGracePeriod(); // Grace period above a valid range
     error InvalidFreezeState(); // Reserve is already in the passed freeze state
+    error InvalidLtvzeroState(); // Reserve is already in the passed ltvzero state
     error NotBorrowableInEMode(); // Asset not borrowable in eMode
     error CallerNotUmbrella(); // The caller of the function is not the umbrella contract
     error ReserveNotInDeficit(); // The reserve is not in deficit
     error MustNotLeaveDust(); // Below a certain threshold liquidators need to take the full position
     error UserCannotHaveDebt(); // Thrown when a user tries to interact with a method that requires a position without debt
     error SelfLiquidation(); // Thrown when a user tries to liquidate themselves
     error CallerNotPositionManager(); // Thrown when the caller has not been enabled as a position manager of the on-behalf-of user
+    error InvalidCollateralInEmode(address reserve, uint256 categoryId); /// Thrown when trying to enter an eMode with an invalid collateral asset
+    error InvalidDebtInEmode(address reserve, uint256 categoryId); /// Thrown when trying to enter an eMode with an invalid debt asset
+    error MustBeEmodeCollateral(address reserve, uint256 categoryId); /// Thrown when trying to configure an asset as eMode-ltvzero that is not an eMode collateral
 }
===================================================================
--- src/contracts/protocol/tokenization/AToken.sol
+++ lib/aave-v3-origin/src/contracts/protocol/tokenization/AToken.sol
@@ -241,9 +241,14 @@
             owner == ECDSA.recover(digest, v, r, s),
             Errors.InvalidSignature()
         );
         _nonces[owner] = currentValidNonce + 1;
-        _approve(owner, spender, value);
+        _approve({
+            owner: owner,
+            spender: spender,
+            amount: value,
+            emitEvent: true
+        });
     }
 
     /// @inheritdoc IERC20
     function transferFrom(
@@ -312,9 +317,8 @@
 
         uint256 index = POOL.getReserveNormalizedIncome(underlyingAsset);
 
         uint256 scaledBalanceFromBefore = super.balanceOf(from);
-        uint256 scaledBalanceToBefore = super.balanceOf(to);
         uint256 scaledAmount = uint256(amount).getATokenTransferScaledAmount(
             index
         );
 
@@ -330,10 +334,9 @@
             asset: underlyingAsset,
             from: from,
             to: to,
             scaledAmount: scaledAmount,
-            scaledBalanceFromBefore: scaledBalanceFromBefore,
-            scaledBalanceToBefore: scaledBalanceToBefore
+            scaledBalanceFromBefore: scaledBalanceFromBefore
         });
     }
 
     /**
===================================================================
--- src/contracts/protocol/libraries/types/DataTypes.sol
+++ lib/aave-v3-origin/src/contracts/protocol/libraries/types/DataTypes.sol
@@ -144,8 +144,9 @@
         uint16 liquidationBonus;
         uint128 collateralBitmap;
         string label;
         uint128 borrowableBitmap;
+        uint128 ltvzeroBitmap; // if true, the asset will be treated as ltv0 and ltv0 rules apply
     }
 
     enum InterestRateMode {
         NONE,
@@ -188,8 +189,9 @@
         address interestRateStrategyAddress;
         uint256 amount;
         address onBehalfOf;
         uint16 referralCode;
+        uint8 supplierEModeCategory;
     }
 
     struct ExecuteBorrowParams {
         address asset;
@@ -239,9 +241,8 @@
         address from;
         address to;
         uint256 scaledAmount;
         uint256 scaledBalanceFromBefore;
-        uint256 scaledBalanceToBefore;
         address oracle;
         uint8 fromEModeCategory;
     }
 
===================================================================
--- src/contracts/protocol/tokenization/base/IncentivizedERC20.sol
+++ lib/aave-v3-origin/src/contracts/protocol/tokenization/base/IncentivizedERC20.sol
@@ -171,9 +171,14 @@
     function approve(
         address spender,
         uint256 amount
     ) external virtual override returns (bool) {
-        _approve(_msgSender(), spender, amount);
+        _approve({
+            owner: _msgSender(),
+            spender: spender,
+            amount: amount,
+            emitEvent: true
+        });
         return true;
     }
 
     /// @inheritdoc IERC20
@@ -182,58 +187,82 @@
         address recipient,
         uint256 amount
     ) external virtual override returns (bool) {
         uint120 castAmount = amount.toUint120();
-        _approve(
-            sender,
-            _msgSender(),
-            _allowances[sender][_msgSender()] - castAmount
-        );
+        _spendAllowance({
+            owner: sender,
+            spender: _msgSender(),
+            amount: castAmount,
+            correctedAmount: castAmount
+        });
         _transfer(sender, recipient, castAmount);
         return true;
     }
 
     /**
+     * @notice Sets the allowance of the caller to spend `owner`'s tokens to 0.
+     * @param owner The address whose tokens are being renounced.
+     */
+    function renounceAllowance(address owner) external virtual {
+        _approve({
+            owner: owner,
+            spender: _msgSender(),
+            amount: 0,
+            emitEvent: true
+        });
+    }
+
+    /**
      * @notice Increases the allowance of spender to spend _msgSender() tokens
+     * @dev This function is deprecated and will be removed in a future version.
+     * @custom:deprecated
      * @param spender The user allowed to spend on behalf of _msgSender()
      * @param addedValue The amount being added to the allowance
      * @return `true`
      */
     function increaseAllowance(
         address spender,
         uint256 addedValue
     ) external virtual returns (bool) {
-        _approve(
-            _msgSender(),
-            spender,
-            _allowances[_msgSender()][spender] + addedValue
-        );
+        _approve({
+            owner: _msgSender(),
+            spender: spender,
+            amount: _allowances[_msgSender()][spender] + addedValue,
+            emitEvent: true
+        });
         return true;
     }
 
     /**
      * @notice Decreases the allowance of spender to spend _msgSender() tokens
+     * @dev This function is deprecated and will be removed in a future version.
+     * @custom:deprecated
      * @param spender The user allowed to spend on behalf of _msgSender()
      * @param subtractedValue The amount being subtracted to the allowance
      * @return `true`
      */
     function decreaseAllowance(
         address spender,
         uint256 subtractedValue
     ) external virtual returns (bool) {
-        _approve(
-            _msgSender(),
-            spender,
-            _allowances[_msgSender()][spender] - subtractedValue
-        );
+        uint256 currentAllowance = _allowances[_msgSender()][spender];
+
+        _approve({
+            owner: _msgSender(),
+            spender: spender,
+            amount: currentAllowance - subtractedValue,
+            emitEvent: true
+        });
         return true;
     }
 
     /**
      * @dev Updates `owner`'s allowance for `spender` based on spent `value`.
      *
      * Revert if not enough allowance is available.
      *
+     * Doesn't emit the Approval event.
+     *
      * @param owner The owner of the tokens
      * @param spender The user allowed to spend on behalf of owner
      * @param amount The minimum amount being consumed from the allowance
      * @param correctedAmount The maximum amount being consumed from the allowance
@@ -252,12 +281,22 @@
                 amount
             );
         }
 
+        if (currentAllowance == type(uint256).max) {
+            return;
+        }
+
         uint256 consumption = currentAllowance >= correctedAmount
             ? correctedAmount
             : currentAllowance;
-        _approve(owner, spender, currentAllowance - consumption);
+
+        _approve({
+            owner: owner,
+            spender: spender,
+            amount: currentAllowance - consumption,
+            emitEvent: false
+        });
     }
 
     /**
      * @notice Transfers tokens between two users and apply incentives if defined.
@@ -296,16 +335,21 @@
      * @notice Approve `spender` to use `amount` of `owner`s balance
      * @param owner The address owning the tokens
      * @param spender The address approved for spending
      * @param amount The amount of tokens to approve spending of
+     * @param emitEvent Whether to emit the Approval event
      */
     function _approve(
         address owner,
         address spender,
-        uint256 amount
+        uint256 amount,
+        bool emitEvent
     ) internal virtual {
         _allowances[owner][spender] = amount;
-        emit Approval(owner, spender, amount);
+
+        if (emitEvent) {
+            emit Approval(owner, spender, amount);
+        }
     }
 
     /**
      * @notice Update the name of the token
===================================================================
--- src/contracts/protocol/libraries/math/WadRayMath.sol
+++ lib/aave-v3-origin/src/contracts/protocol/libraries/math/WadRayMath.sol
@@ -77,17 +77,8 @@
             c := div(add(mul(a, b), HALF_RAY), RAY)
         }
     }
 
-    function rayMul(
-        uint256 a,
-        uint256 b,
-        Rounding rounding
-    ) internal pure returns (uint256 c) {
-        if (rounding == Rounding.Floor) return rayMulFloor(a, b);
-        return rayMulCeil(a, b);
-    }
-
     function rayMulFloor(
         uint256 a,
         uint256 b
     ) internal pure returns (uint256 c) {
@@ -135,17 +126,8 @@
             c := div(add(mul(a, RAY), div(b, 2)), b)
         }
     }
 
-    function rayDiv(
-        uint256 a,
-        uint256 b,
-        Rounding rounding
-    ) internal pure returns (uint256 c) {
-        if (rounding == Rounding.Floor) return rayDivFloor(a, b);
-        return rayDivCeil(a, b);
-    }
-
     function rayDivCeil(
         uint256 a,
         uint256 b
     ) internal pure returns (uint256 c) {
